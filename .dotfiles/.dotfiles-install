#!/usr/bin/env bash

backup() {
  git --work-tree=$HOME --git-dir=$HOME/.dotfiles.backup "$@"
}

dotfiles() {
  git --work-tree=$HOME --git-dir=$HOME/.dotfiles.git "$@"
}

install() {
  git clone --bare $1github.com$2reinventing-wheels/dotfiles.git ~/.dotfiles.git || return

  pushd ~
    backup init
    dotfiles ls-tree --full-tree -r --name-only HEAD | while read f; do
      [[ -f $f ]] && backup add $f
    done
    backup config user.name backup
    backup config user.email backup
    backup commit -m backup
    rm $(backup ls-tree -r --name-only HEAD)

    dotfiles config --local status.showUntrackedFiles no
    dotfiles checkout
    dotfiles submodule update --init --depth 1
  popd
}

[[ $- = *s* ]] && case $1 in
  ssh) install git@     : ;;
  *)   install https:// / ;;
esac
